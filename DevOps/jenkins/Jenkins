#!groovy
pipeline {
    agent any
    environment {
            TOKEN = 'b2a35a7e-2e9f-4f77-87d9-e3fbd10ba8f9'
            PROJECT_VERSION = '1.0.0'
            DOCKERHUB_CREDENTIALS = credentials("dockerhub-cred-alimkugot")
            DOCKERHUB_HOST = 'alimkugot'
    }
// sfsaasdf
    tools {
        maven 'maven-installer-3.8.6'
    }

    stages {
        stage('Maven test') {
            steps {
                sh 'mvn -pl ${PROJECT_NAME} test'
            }
        }
//
//        stage('Maven build') {
//            steps {
//                sh 'mvn clean install -DskipTests -f ${PROJECT_NAME}/pom.xml spring-boot:repackage'
//            }
//        }

        stage('Publish Test Coverage Report') {
            steps {
                dir("${PROJECT_NAME}") {
//                    step([$class: 'JacocoPublisher',
//                          execPattern: '**/build/jacoco/*.exec',
//                          classPattern: '**/build/classes',
//                          sourcePattern: 'src/main/java',
//                          exclusionPattern: 'src/test*'
//                    ])
                    sh 'ls'
                    sh 'curl -Os https://uploader.codecov.io/latest/linux/codecov'
                    sh 'chmod +x codecov'
                    sh './codecov -t ${TOKEN}'
                }
            }
        }

        stage('Docker login') {
            steps {
                sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
            }
        }

        stage('Docker build') {
            steps {
                dir("${PROJECT_NAME}") {
                    sh 'docker build -t ${DOCKERHUB_HOST}/${PROJECT_NAME}:${PROJECT_VERSION} .'
                    sh 'docker build -t ${DOCKERHUB_HOST}/${PROJECT_NAME}:latest .'
                }
            }
        }

        stage('Docker push') {
            steps {
                script {
                    sh 'docker push ${DOCKERHUB_HOST}/${PROJECT_NAME}:${PROJECT_VERSION}'
                    sh 'docker push ${DOCKERHUB_HOST}/${PROJECT_NAME}:latest'
                }
            }
        }

        stage('Docker clean up') {
            steps {
                sh "docker rmi ${DOCKERHUB_HOST}/${PROJECT_NAME}:${PROJECT_VERSION}"
                sh "docker rmi ${DOCKERHUB_HOST}/${PROJECT_NAME}:latest"
            }
        }
    }

    post {
        always {
            sh 'docker logout'
        }
    }
}